<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>10進⇒2進 ＆ 16進 まとめ学習ゲーム（単一問題・縦レイアウト）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#f0f8ff; --ink:#333; --muted:#666;
      --tile:#e6f2ff; --tile-active:#b3e0ff; --border:#ccc;
      --ok:#16a34a; --ng:#dc2626; --btn:#2563eb; --btn2:#059669;
    }
    *{box-sizing:border-box}
    body{font-family:sans-serif; background:var(--bg); margin:0; padding:16px; color:var(--ink);}    
    h1{margin:0 0 12px}
    h2{margin:18px 0 8px; font-size:18px}
    .wrap{max-width:820px; margin:0 auto; display:flex; flex-direction:column; gap:18px;}
    .panel{background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,.04)}
    .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}

    button{cursor:pointer; padding:8px 14px; border-radius:8px; border:1px solid #d1d5db; background:#fff; font-size:14px;}
    .primary{ background:var(--btn); color:#fff; border-color:transparent}
    .success{ background:var(--btn2); color:#fff; border-color:transparent}
    .ghost{ background:#fff}
    .pill{ border-radius:999px; }

    /* 問題枠 */
    .problem{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .problem-badge{font-weight:700; font-size:18px; padding:6px 12px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe;}
    .problem-num{font-size:22px; font-weight:700; letter-spacing:0.5px;}

    /* ① タイル */
    #tile-container-wrapper{ overflow-x:auto; display:flex; justify-content:center; margin-top:12px; }
    #tile-container{ display:flex; gap:10px; }
    .tile-wrapper{ display:flex; flex-direction:column; align-items:center; }
    .tile{ width:50px; height:50px; background:var(--tile); border:2px solid var(--border); font-size:24px; line-height:50px; text-align:center; user-select:none; }
    .tile.active{ background:var(--tile-active); }
    .weight{ font-size:12px; color:#333; margin-top:4px; }
    .weight.hidden{ visibility:hidden; }

    /* ② 16進入力 + ヒント */
    .binary-display{ font-size:18px; font-weight:700; color:#004d99; letter-spacing:1px; display:inline-flex; align-items:center; gap:10px; padding:6px 10px; border-radius:8px; background:#ecfeff; border:1px solid #bae6fd; }

    .nibbles{ display:flex; gap:10px; align-items:flex-start; justify-content:center; flex-wrap:wrap; margin-top:10px; }
    .nibble{ display:grid; grid-template-columns:repeat(4, 1fr); gap:6px; padding:10px; border-radius:10px; background:#f8fafc; border:1px dashed #94a3b8; }
    .bitbox{ display:flex; flex-direction:column; align-items:center; gap:6px; }
    .bit{ width:38px; height:38px; border:1px solid #cbd5e1; display:flex; align-items:center; justify-content:center; font-weight:700; background:#fff; border-radius:6px;}
    .w-input{ width:38px; text-align:center; padding:4px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px;}
    .w-note{font-size:11px; color:var(--muted); text-align:center; margin-top:6px}
    .w-wrap{display:none}
    .w-wrap.show{display:block}

    .field{ display:inline-flex; align-items:center; gap:8px; }

    /* ②のHEX桁ごとの選択UI */
    #hexSelects{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .hex-digit{ display:flex; flex-direction:column; align-items:center; gap:4px; }
    .hex-digit select{ padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; font-size:16px; min-width:56px; text-align:center; }
    .hex-digit label{ font-size:12px; color:#64748b; }

    .feedback{ margin-top:10px; min-height:28px; font-size:16px; }
    .ok{ color:var(--ok); }
    .ng{ color:var(--ng); }
    .summary{ margin-top:14px; padding:10px; border-radius:10px; background:#f5f5ff; border:1px solid #e0e7ff; }

    /* ②枠：左に問題UI、右にメモ欄 */
    .secB-main{
      display:flex;
      gap:16px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .secB-left{
      flex:1 1 320px;
      min-width:0;
    }
    .memo-box{
      flex:0 0 220px;
      max-width:260px;
      background:#f9fafb;
      border:1px dashed #cbd5e1;
      border-radius:10px;
      padding:8px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .memo-title{
      font-size:13px;
      font-weight:700;
      color:#475569;
    }
    .memo-box textarea{
      width:100%;
      min-height:140px;
      resize:vertical;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      font-size:13px;
      font-family:inherit;
    }

    @media (max-width:640px){
      .secB-main{
        flex-direction:column;
      }
      .memo-box{
        width:100%;
        max-width:none;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>10進⇒2進・16進 まとめ学習（単一問題で①②に回答）</h1>

    <!-- コントロール -->
    <div class="row" id="top-controls">
      <button class="pill" onclick="setMode('easy')">4ビット（初級）</button>
      <button class="pill" onclick="setMode('mid')">8ビット（中級）</button>
      <button class="pill" onclick="setMode('hard')">12ビット（上級）</button>
      <button class="pill ghost" onclick="toggleHint()">ヒント表示/非表示</button>
      <button class="pill primary" onclick="gradeAll()">回答（①②まとめて採点）</button>
      <button class="pill success" onclick="nextAll()">次の問題</button>
    </div>

    <!-- 問題枠：ここに本問の10進数を提示 → ①は2進、②は16進に変換 -->
    <section class="panel" id="secProblem">
      <div class="problem">
        <span class="problem-badge">問題</span>
        <div class="problem-num">10進数：<span id="problemDecimal">--</span></div>
      </div>
    </section>

    <!-- ① 10進 ⇒ 2進（タイル）-->
    <section class="panel" id="secA">
      <h2>① 10進 ⇒ 2進（タイルをON/OFF）</h2>
      <div id="tile-container-wrapper"><div id="tile-container"></div></div>
      <div class="feedback" id="fbA"></div>
    </section>

    <!-- ② 10進 ⇒ 16進（HEX選択）＋右側メモ欄 -->
    <section class="panel" id="secB">
      <h2>② 10進 ⇒ 16進（各桁を選択）</h2>

      <div class="secB-main">
        <!-- 左側：これまでの②のUI -->
        <div class="secB-left">
          <div class="row">
            <div class="binary-display" id="binaryDisplay">現在の2進：---- ----</div>
          </div>

          <div class="w-wrap" id="hintWeights">
            <div class="nibbles" id="nibbles"></div>
            <div class="w-note">ヒント：4桁ごとに枠で区切り、各ビットの重み（8,4,2,1）を書いて確認しましょう。</div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div id="hexSelects" aria-label="16進数の各桁"></div>
          </div>

          <div class="feedback" id="fbB"></div>
        </div>

        <!-- 右側：自由メモ欄 -->
        <aside class="memo-box" aria-label="計算メモ欄">
          <div class="memo-title">メモ</div>
          <textarea id="memoArea" placeholder="計算途中のメモを書いてください"></textarea>
        </aside>
      </div>
    </section>

    <div class="summary" id="summary"></div>
  </div>

  <script>
    let showHint = false;
    let mode = 'easy';
    let bitCount = 4;
    let problemNumber = 0;

    function setMode(newMode){
      mode = newMode;
      bitCount = (mode === 'easy') ? 4 : (mode === 'mid' ? 8 : 12);
      nextAll();
    }

    function nextAll(){
      const max = (1 << bitCount) - 1;
      problemNumber = Math.floor(Math.random() * (max + 1));
      document.getElementById('problemDecimal').textContent = problemNumber;
      renderTiles();
      buildHexSelects(Math.ceil(bitCount/4));
      document.getElementById('fbA').innerText = '';
      document.getElementById('fbB').innerText = '';
      document.getElementById('summary').innerText = '';
      syncBinaryFromTiles();
    }

    function renderTiles(){
      const container = document.getElementById('tile-container');
      container.innerHTML = '';
      for(let i=0;i<bitCount;i++){
        const w = document.createElement('div');
        w.className = 'tile-wrapper';
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.innerText = '0';
        tile.onclick = ()=>{ toggleBit(tile); };
        w.appendChild(tile);
        const weight = document.createElement('div');
        weight.className = 'weight';
        weight.innerText = 2 ** (bitCount - 1 - i);
        weight.classList.toggle('hidden', !showHint);
        w.appendChild(weight);
        container.appendChild(w);
      }
    }

    function toggleBit(tile){
      const isActive = tile.classList.toggle('active');
      tile.innerText = isActive ? '1' : '0';
      syncBinaryFromTiles();
    }

    function getTilesBinary(){
      const tiles = document.querySelectorAll('#tile-container .tile');
      let bin = '';
      tiles.forEach(t => bin += t.innerText);
      return bin.padStart(bitCount, '0');
    }

    function tilesValue(){
      const bin = getTilesBinary();
      return parseInt(bin || '0', 2);
    }

    function groupByNibble(bin){
      return bin.replace(/(.{4})/g, '$1 ').trim();
    }

    function syncBinaryFromTiles(){
      const raw = getTilesBinary().padStart(bitCount, '0');
      const nbits = Math.max(4, Math.ceil(bitCount/4)*4);
      const binPadded = raw.padStart(nbits, '0');
      document.getElementById('binaryDisplay').textContent = `現在の2進：${groupByNibble(binPadded)}`;
      buildNibbleHint(binPadded);
    }

    function buildNibbleHint(binPadded){
      const cont = document.getElementById('nibbles');
      cont.innerHTML='';
      const nibbleCount = binPadded.length / 4;
      const weightsNibble = [8,4,2,1];
      for(let n=0;n<nibbleCount;n++){
        const nib = document.createElement('div');
        nib.className = 'nibble';
        for(let k=0;k<4;k++){
          const i = n*4 + k;
          const cell = document.createElement('div');
          cell.className = 'bitbox';
          const bit = document.createElement('div');
          bit.className = 'bit';
          bit.textContent = binPadded[i];
          cell.appendChild(bit);
          const inp = document.createElement('input');
          inp.type = 'number';
          inp.className = 'w-input';
          inp.placeholder = weightsNibble[k];
          inp.dataset.expected = String(weightsNibble[k]);
          cell.appendChild(inp);
          nib.appendChild(cell);
        }
        cont.appendChild(nib);
      }
      document.getElementById('hintWeights').classList.toggle('show', showHint);
    }

    function buildHexSelects(digits){
      const holder = document.getElementById('hexSelects');
      holder.innerHTML = '';
      const choices = ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'];
      for(let i=0;i<digits;i++){
        const wrap = document.createElement('div');
        wrap.className = 'hex-digit';
        const lab = document.createElement('label');
        lab.textContent = `${i+1}桁目`;
        const sel = document.createElement('select');
        sel.setAttribute('data-idx', String(i));
        for(const ch of choices){
          const op = document.createElement('option');
          op.value = ch; op.textContent = ch;
          sel.appendChild(op);
        }
        sel.value = '0'; // 初期値を0に設定
        wrap.appendChild(sel);
        wrap.appendChild(lab);
        holder.appendChild(wrap);
      }
    }

    function getUserHexFromSelects(){
      const sels = Array.from(document.querySelectorAll('#hexSelects select'));
      if (sels.length === 0) return '';
      return sels.map(s => (s.value || '0')).join('').toUpperCase();
    }

    function toggleHint(){
      showHint = !showHint;
      document.querySelectorAll('.weight').forEach(w => w.classList.toggle('hidden', !showHint));
      document.getElementById('hintWeights').classList.toggle('show', showHint);
    }

    function normalizeHex(s){
      return (s||'').replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).toUpperCase();
    }

    function gradeAll(){
      const fbA = document.getElementById('fbA');
      const fbB = document.getElementById('fbB');
      const summary = document.getElementById('summary');

      const correctBin = problemNumber.toString(2).padStart(bitCount,'0');
      const hexDigits = Math.ceil(bitCount/4);
      const correctHex = problemNumber.toString(16).toUpperCase().padStart(hexDigits, '0');

      const userVal = tilesValue();
      const okA = (userVal === problemNumber);
      fbA.innerHTML = okA ? `<span class='ok'>正解！</span>` : `<span class='ng'>不正解。</span> 正解は <code>${correctBin}</code>`;

      let userHex = getUserHexFromSelects();
      userHex = normalizeHex(userHex);
      const okB = (userHex === correctHex);
      fbB.innerHTML = okB ? `<span class='ok'>正解！</span>` : `<span class='ng'>不正解。</span> 正解は <code>${correctHex}</code>`;

      summary.innerHTML = `<strong>採点結果：</strong> ① ${okA?'○':'×'} / ② ${okB?'○':'×'}`;
    }

    window.addEventListener('load', ()=>{
      setMode('easy');
    });
  </script>
</body>
</html>
